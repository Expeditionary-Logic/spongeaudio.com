<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Setup Sources - Sponge Audiobook Player</title>
    <link rel="stylesheet" href="style.css">
</head>
<body class="sponge-page">
    <nav class="navbar">
        <div class="container">
            <a href="index.html" class="logo">Sponge</a>
            <ul class="nav-links">
                <li><a href="index.html">Home</a></li>
                <li><a href="instructions.html">Instructions</a></li>
                <li><a href="setup-sources.html">Setup Sources</a></li>
                <li><a href="contact.html">Contact</a></li>
            </ul>
        </div>
    </nav>

    <main class="container">
        <section class="page-hero">
            <h1>Setup Sources</h1>
            <p class="subtitle">Generate a link to add audiobook sources to Sponge</p>
        </section>

        <section class="content-card">
            <h2>How It Works</h2>
            <p>
                Use this form to generate a special link. Send it to yourself (e.g. email or text) and open that link from your Apple Watch to configure an audiobook source in Sponge without having to type it on your tiny screen.
            </p>
            <p>
                <strong>This form runs entirely in your browser—no data is sent to any server.</strong> Your credentials stay on your device.
            </p>
        </section>

        <section class="content-card">
            <h2>Enter Your Server Details</h2>
            <p style="color: #666; font-size: 0.95rem; margin-bottom: 1.5rem;">All fields are optional. Fill in what you'd like to pre-populate on your watch.</p>
            <form id="source-form" class="source-form">
                <div class="form-group">
                    <label for="source-type">Source Type</label>
                    <select id="source-type" name="source-type">
                        <option value="abs">AudiobookShelf</option>
                    </select>
                </div>

                <div class="form-group">
                    <label for="server-url">Server URL <span style="font-weight: normal; color: #888;">(optional)</span></label>
                    <input type="url" id="server-url" name="server-url" placeholder="https://your-server.com">
                </div>

                <div class="form-group">
                    <label for="username">Username <span style="font-weight: normal; color: #888;">(optional)</span></label>
                    <input type="text" id="username" name="username" placeholder="your-username">
                </div>

                <div class="form-group">
                    <label for="password">Password <span style="font-weight: normal; color: #888;">(optional)</span></label>
                    <input type="password" id="password" name="password" placeholder="your-password">
                    <p style="color: #888; font-size: 0.85rem; margin-top: 0.5rem;">
                        <strong>Recommendation:</strong> Leave this blank and enter your password directly on your watch for better security.
                        If included, the password is obfuscated but not encrypted.
                    </p>
                </div>
            </form>
        </section>

        <section class="content-card">
            <h2>Your Setup Link</h2>
            <p class="url-instructions">Send this link to yourself (via email, message, etc.) and open it on your Apple Watch to add the source to Sponge.</p>
            <div class="url-display">
                <code id="generated-url">https://spongeaudio.com/add-source/audiobookshelf</code>
                <button type="button" id="copy-button" class="copy-button" title="Copy to clipboard">
                    <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                        <rect x="9" y="9" width="13" height="13" rx="2" ry="2"></rect>
                        <path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"></path>
                    </svg>
                </button>
            </div>
            <p id="copy-feedback" class="copy-feedback"></p>
        </section>

        <section class="content-card">
            <h2>Manual URL Construction</h2>
            <p style="margin-bottom: 1rem;">
                You can also construct your own setup URL without using this form. The URL format is:
            </p>
            <code style="display: block; background: #f5f5f5; padding: 1rem; border-radius: 6px; margin-bottom: 1.5rem; word-break: break-all;">
                https://spongeaudio.com/add-source/audiobookshelf?url=...&amp;username=...&amp;password=...
            </code>
            <p style="margin-bottom: 1rem;"><strong>Parameters:</strong></p>
            <ul style="color: #555; line-height: 1.8; margin-left: 1.5rem;">
                <li><strong>url</strong> — Your server URL (e.g., <code>https://books.example.com</code>). Must be URL-encoded.</li>
                <li><strong>username</strong> — Your username. Must be URL-encoded if it contains special characters.</li>
                <li><strong>password</strong> — Your password in plaintext. Must be URL-encoded if it contains special characters.</li>
                <li><strong>p</strong> — An obfuscated password. The form above uses this parameter instead of <code>password</code>.</li>
            </ul>
            <p style="margin-top: 1rem; color: #666;">
                All parameters are optional. If you're constructing your own URL, we recommend using the <code>password</code> parameter with your plaintext password rather than trying to generate the obfuscated <code>p</code> parameter yourself.
            </p>
        </section>
    </main>

    <footer>
        <div class="container">
            <p>&copy; <span id="current-year"></span> <a href="https://expeditionarylogic.com">Expeditionary Logic, LLC</a></p>
        </div>
    </footer>

    <script>
        document.getElementById('current-year').textContent = new Date().getFullYear();

        // Pre-shared key for password obfuscation (XOR encoding)
        const OBFUSCATION_KEY = 'ZetMxyZl8blT/cZSz2+wZeJ3KiUrQfQ0MQzeTMoK457aFC6Fk556q6esN7/Xzki5';

        const sourceType = document.getElementById('source-type');
        const serverUrl = document.getElementById('server-url');
        const username = document.getElementById('username');
        const password = document.getElementById('password');
        const generatedUrl = document.getElementById('generated-url');
        const copyButton = document.getElementById('copy-button');
        const copyFeedback = document.getElementById('copy-feedback');

        // XOR a string with the key, return base64
        function obfuscatePassword(plaintext) {
            if (!plaintext) return '';

            const keyBytes = new TextEncoder().encode(OBFUSCATION_KEY);
            const plaintextBytes = new TextEncoder().encode(plaintext);
            const result = new Uint8Array(plaintextBytes.length);

            for (let i = 0; i < plaintextBytes.length; i++) {
                result[i] = plaintextBytes[i] ^ keyBytes[i % keyBytes.length];
            }

            // Convert to base64
            let binary = '';
            for (let i = 0; i < result.length; i++) {
                binary += String.fromCharCode(result[i]);
            }
            return btoa(binary);
        }

        function updateGeneratedUrl() {
            const type = sourceType.value === 'abs' ? 'audiobookshelf' : sourceType.value;
            const params = [];

            if (serverUrl.value.trim()) {
                params.push(`url=${encodeURIComponent(serverUrl.value.trim())}`);
            }
            if (username.value.trim()) {
                params.push(`username=${encodeURIComponent(username.value.trim())}`);
            }
            if (password.value) {
                const obfuscated = obfuscatePassword(password.value);
                params.push(`p=${encodeURIComponent(obfuscated)}`);
            }

            let url = `https://spongeaudio.com/add-source/${type}`;
            if (params.length > 0) {
                url += '?' + params.join('&');
            }

            generatedUrl.textContent = url;
        }

        sourceType.addEventListener('change', updateGeneratedUrl);
        serverUrl.addEventListener('input', updateGeneratedUrl);
        username.addEventListener('input', updateGeneratedUrl);
        password.addEventListener('input', updateGeneratedUrl);

        copyButton.addEventListener('click', async function() {
            const urlText = generatedUrl.textContent;

            try {
                await navigator.clipboard.writeText(urlText);
                copyFeedback.textContent = 'Copied to clipboard!';
                copyFeedback.classList.add('show');

                setTimeout(() => {
                    copyFeedback.classList.remove('show');
                }, 2000);
            } catch (err) {
                copyFeedback.textContent = 'Failed to copy. Please select and copy manually.';
                copyFeedback.classList.add('show', 'error');

                setTimeout(() => {
                    copyFeedback.classList.remove('show', 'error');
                }, 3000);
            }
        });

        // Initialize
        updateGeneratedUrl();
    </script>
</body>
</html>
